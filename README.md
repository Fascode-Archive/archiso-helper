# archiso-builder
ArchISOの補助を行います。デフォルト設定で最新のLiveCDをビルドすることもできます。  
~~（もともとは最新のCDをビルドするためだったんだが...）~~  
↑のスクリプトはarchlinux-builder-mini.shです。  
永遠のalpha版、安定版なんてなかった。（Release1では「完成」となっていますが、実際には多くのバグがあるのでarchlinux-builder-mini.shを使用することをおすすめします。）  


# テスト中の機能
このスクリプトは永遠のalphaです。ここでは、現在動作が不安定なものを挙げています  
~~安定していない機能でも構わずmasterにぶちこみます。~~ 。  
最近危険なことはtestブランチでやるようにしました。実装の殆どが危ないのでmasterだけ見ると全く進んでいません。たぶん大丈夫っしょって思ったらmasterに反映するかも。  
- ArchLinuxのビルド機能（時々失敗します。再実行すると成功します。）
- AURの自動ビルド（整合性エラーが発生する場合があります。何度か再実行するとうまくいくことがあります。安定して動作させたい場合は手動でカスタムリポジトリを作成してください。）
- Grub背景の変更（初期の方に実装されたけど実は一回もテストしてない）



# 現在わかっているバグ
複数回実行していると成功する場合があり、原因がわかっていません。
- AURの自動ビルドでインストール直前で整合性エラーが出る場合があります。
- ~~ 初回実行時のみ、build.shが見つからない場合があります。2回目以降でこのバグが起きたことはありません。 ~~  
現在、build.shを内蔵することによって対応していますが、configすべてが正常にコピーできていない場合もありますので注意してください。



# 注意事項
- ビルドに失敗する場合はもう一度実行してみてください  
- customize_airootfs.shの実行後にエラーが出る場合は、再起動するとビルドできる場合があります。  
- カーネルを更新後、再起動していない状態で（古いカーネルを実行したまま）ビルドを開始するとエラーが出ます。必ずインストールされているカーネルと実行中のカーネルを一致させてください。  
- 設定には干渉する値もあります。十分に注意して設定してください。  
- スクリプトはRootユーザーが書き込み権限のあるディレクトリで実行する必要があります。  
- カスタムリポジトリのディレクトリはAURユーザーの書き込み権限のあるディレクトリを指定する必要があります。
- このスクリプトはArchLinuxでのみテストされています。ManjaroなどのArch系列で実行する場合はディストリビューションチェックをコメントアウトしてください。

# 実行方法
デフォルトでは/home/直下にarchlinux-hogehoge-x86_64.isoで作成されます。

__注意__ 現在スクリプトの構造を大幅に変更しており、利用できません。[こちら](https://github.com/Hayao0819/archiso-helper/tree/abbdd2f03db07b8b37c94dad96e415334f6e3bfa)の過去のものを使用するか、oldディレクトリのものを使用してください。

# 追加のファイルについて
以下のファイルはすべてoldディレクトリ内にあります。  
settings.bashやbuild_i686.shは必須ではありません。  

## start_build.bash
このファイルはビルドする際のランチャーとなるものです。  
必要なファイルを自動でダウンロード、実行します。  
スクリプト内部では、設定ファイルへのURLを指定できます。  
実行するたびにダウンロードを行うので常に最新の状態で利用できます。　　

## message.bash
必須のファイルです。単体で実行した場合は自動でダウンロードされます。  
このファイルを編集することで言語を追加できます。  

## settings.bash
設定を記述したファイルです。archlinux_builder.bashを更新した際に設定を保存できるファイルです。  
引数として設定ファイルへのパスを指定することができます。  
~~（更新によって設定項目が追加された場合、settings.bashに手動で追加する必要があります。）~~  
`ce77b3c `以降は設定が存在しなかった場合はデフォルト設定が使用されます。

## build_i686.sh
i686でビルドするためのスクリプトです。  
直接実行せず、archlinux-builder.bashを経由して実行してください。  
x86_64をビルドする場合は不要です。  

## aur.bash
AURにあるパッケージをビルドして、*.pkg.tar.xzにします。ビルドするには引数としてAURのリポジトリを指定してください。  
スクリプトと同じ階層にパッケージが作成されます。カスタムリポジトリを利用する際に利用できます。  


## archlinux-builder-mini.sh
ArchLinuxの純粋なLiveCDを生成します。（これが本来作りたかったスクリプト）  
生成時の最新のパッケージをそのままイメージファイルにします。

```bash
./aur.bash hogehoge fugafuga
```

## mkarchiso-jp-bar.patch
ArchISOの本体であるmkarchisoへパッチを行うものです。  
このパッチはmkarchisoにて以下のことを可能にします。  
- pacman等のメッセージの日本語化  
- squashfsのバーの表示  
パッチは以下のコマンドで適用できます。

```bash
sudo patch < mkarchiso-jp-bar.patch
```

パッチを適用前に戻すには以下のコマンドを実行してください。

```bash
sudo patch -R -u < mkarchiso-jp-bar.patch
```


# アーキテクチャについて
ビルドを実行したマシンと同じアーキテクチャしかビルドできません。i686はarchiso本体でバグがあるようで正常に動作しません。  
つまり事実上x86_64しか動作しません。（archisoがあればその他のアーキテクチャでも動かせる設計にはなっているはず）



# 設定
設定はsettings.bashで設定することが推奨されています。  
（スクリプト内で設定することも可能です。）  
設定はスクリプト内に細かく書かれています。  
